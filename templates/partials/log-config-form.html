{{ define "log-config-form" }}
<form
    x-data="{
        outputType: '{{ if .LogConfig }}{{ .LogConfig.OutputType }}{{ else }}stderr{{ end }}',
        filePath: '{{ if .LogConfig }}{{ .LogConfig.FilePath }}{{ end }}',
        format: '{{ if .LogConfig }}{{ .LogConfig.Format }}{{ end }}',
        level: '{{ if .LogConfig }}{{ .LogConfig.Level }}{{ end }}',
        rollSize: '{{ if .LogConfig }}{{ .LogConfig.RollSize }}{{ end }}',
        rollKeep: '{{ if .LogConfig }}{{ .LogConfig.RollKeep }}{{ end }}',
        rollKeepDays: '{{ if .LogConfig }}{{ .LogConfig.RollKeepDays }}{{ end }}',
        submitting: false,

        getPreview() {
            let lines = [];
            lines.push('log {');

            // Output
            if (this.outputType === 'file' && this.filePath) {
                if (this.rollSize || this.rollKeep || this.rollKeepDays) {
                    lines.push('    output file ' + this.filePath + ' {');
                    if (this.rollSize) {
                        lines.push('        roll_size ' + this.rollSize);
                    }
                    if (this.rollKeep) {
                        lines.push('        roll_keep ' + this.rollKeep);
                    }
                    if (this.rollKeepDays) {
                        lines.push('        roll_keep_for ' + this.rollKeepDays + 'd');
                    }
                    lines.push('    }');
                } else {
                    lines.push('    output file ' + this.filePath);
                }
            } else if (this.outputType === 'stdout') {
                lines.push('    output stdout');
            } else if (this.outputType === 'stderr') {
                lines.push('    output stderr');
            } else if (this.outputType === 'discard') {
                lines.push('    output discard');
            }

            // Format
            if (this.format) {
                lines.push('    format ' + this.format);
            }

            // Level
            if (this.level) {
                lines.push('    level ' + this.level);
            }

            lines.push('}');
            return lines.join('\n');
        }
    }"
    hx-put="/global-options/log"
    hx-target="#log-config-content"
    hx-swap="innerHTML"
    @htmx:before-request="submitting = true"
    @htmx:after-request="submitting = false"
    class="grid grid-cols-1 lg:grid-cols-2 gap-6"
>
    <!-- Form Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 pb-2 border-b">Logging Settings</h3>

        {{ if .HasError }}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-red-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-red-700">{{ .Error }}</span>
            </div>
        </div>
        {{ end }}

        <!-- Output Type Field -->
        <div class="mb-6">
            <label for="output_type" class="block text-sm font-medium text-gray-700 mb-2">
                Output Destination
            </label>
            <select
                id="output_type"
                name="output_type"
                x-model="outputType"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
                <option value="stderr">Standard Error (stderr)</option>
                <option value="stdout">Standard Output (stdout)</option>
                <option value="file">File</option>
                <option value="discard">Discard (no logging)</option>
            </select>
            <p class="mt-1 text-sm text-gray-500">
                Where log output should be written
            </p>
        </div>

        <!-- File Path Field (shown when output type is file) -->
        <div x-show="outputType === 'file'" x-transition class="mb-6">
            <label for="file_path" class="block text-sm font-medium text-gray-700 mb-2">
                Log File Path
            </label>
            <input
                type="text"
                id="file_path"
                name="file_path"
                x-model="filePath"
                placeholder="/var/log/caddy/access.log"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
            <p class="mt-1 text-sm text-gray-500">
                Full path to the log file (e.g., /var/log/caddy/access.log)
            </p>
        </div>

        <!-- Log Format Field -->
        <div class="mb-6">
            <label for="format" class="block text-sm font-medium text-gray-700 mb-2">
                Log Format
            </label>
            <select
                id="format"
                name="format"
                x-model="format"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
                <option value="">Default</option>
                <option value="json">JSON</option>
                <option value="console">Console (human-readable)</option>
            </select>
            <p class="mt-1 text-sm text-gray-500">
                Format of log output. JSON is recommended for log aggregation tools.
            </p>
        </div>

        <!-- Log Level Field -->
        <div class="mb-6">
            <label for="level" class="block text-sm font-medium text-gray-700 mb-2">
                Log Level
            </label>
            <select
                id="level"
                name="level"
                x-model="level"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
                <option value="">Default (INFO)</option>
                <option value="DEBUG">DEBUG - Verbose debugging information</option>
                <option value="INFO">INFO - General information</option>
                <option value="WARN">WARN - Warnings only</option>
                <option value="ERROR">ERROR - Errors only</option>
            </select>
            <p class="mt-1 text-sm text-gray-500">
                Minimum severity level to log
            </p>
        </div>

        <!-- Roll Settings (shown when output type is file) -->
        <div x-show="outputType === 'file'" x-transition class="mb-6">
            <h4 class="text-md font-medium text-gray-700 mb-3">Log Rotation Settings</h4>
            <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                <div>
                    <label for="roll_size" class="block text-sm font-medium text-gray-700 mb-2">
                        Roll Size
                    </label>
                    <input
                        type="text"
                        id="roll_size"
                        name="roll_size"
                        x-model="rollSize"
                        placeholder="100mb"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <p class="mt-1 text-sm text-gray-500">
                        Maximum log file size before rotation (e.g., 10mb, 100kb, 1gb)
                    </p>
                </div>
                <div>
                    <label for="roll_keep" class="block text-sm font-medium text-gray-700 mb-2">
                        Roll Keep (count)
                    </label>
                    <input
                        type="number"
                        id="roll_keep"
                        name="roll_keep"
                        x-model="rollKeep"
                        placeholder="10"
                        min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <p class="mt-1 text-sm text-gray-500">
                        Number of rotated log files to keep
                    </p>
                </div>
                <div>
                    <label for="roll_keep_days" class="block text-sm font-medium text-gray-700 mb-2">
                        Roll Keep (days)
                    </label>
                    <input
                        type="number"
                        id="roll_keep_days"
                        name="roll_keep_days"
                        x-model="rollKeepDays"
                        placeholder="90"
                        min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                    <p class="mt-1 text-sm text-gray-500">
                        Number of days to keep rotated log files
                    </p>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end space-x-4 pt-4 border-t border-gray-200">
            <a
                href="/global-options"
                class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900"
            >
                Cancel
            </a>
            <button
                type="submit"
                :disabled="submitting"
                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                <svg
                    x-show="submitting"
                    class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                >
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span x-text="submitting ? 'Saving...' : 'Save & Reload Caddy'"></span>
            </button>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4 pb-2 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Generated Caddyfile Block</h3>
            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Live Preview</span>
        </div>

        <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
            <pre class="text-sm text-gray-100 font-mono"><code x-text="getPreview()"></code></pre>
        </div>

        <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="text-sm text-blue-700">
                    <p class="font-medium">About Caddy Logging</p>
                    <p class="mt-1">
                        This log block will be added to your global options and applies to all sites.
                        Individual sites can override these settings with their own log directives.
                    </p>
                </div>
            </div>
        </div>

        <!-- Current Configuration Display -->
        {{ if .HasCurrentConfig }}
        <div class="mt-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Current Configuration</h4>
            <div class="bg-gray-100 rounded-lg p-4 overflow-x-auto">
                <pre class="text-sm text-gray-700 font-mono"><code>{{ .CurrentConfigPreview }}</code></pre>
            </div>
        </div>
        {{ end }}
    </div>
</form>
{{ end }}
